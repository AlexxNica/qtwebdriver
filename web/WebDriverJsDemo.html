<html>
  <head>
    <style type="text/css">
      .unitLabel {
        font-size: small;
      }

      .commandBlock {
        margin-top: 20px;
        border-style: solid;
        border-width: thin;
        border-color: gray;
      }
    </style>
    <script src="webdriver.js"></script>
    <script src="base64-arraybuffer.js"></script>
    <script src="FileSaver.js"></script>
    <script src="hammer.min.js"></script>
    <script>
      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/startsWith
      if (!String.prototype.startsWith) {
        Object.defineProperty(String.prototype, 'startsWith', {
          enumerable: false,
          configurable: false,
          writable: false,
          value: function (searchString, position) {
            position = position || 0;
            return this.indexOf(searchString, position) === position;
          }
        });
      }
      if (!String.prototype.endsWith) {
        Object.defineProperty(String.prototype, 'endsWith', {
          enumerable: false,
          configurable: false,
          writable: false,
          value: function (searchString, position) {
            position = position || this.length;
            position = position - searchString.length;
            var lastIndex = this.lastIndexOf(searchString);
            return lastIndex !== -1 && lastIndex === position;
          }
        });
      }

      function loadFile(url) {
        var req = new XMLHttpRequest();
        req.open('GET', url, false);
        try {
          req.send();
          return req.responseText;
        } catch (err) {
          var message = 'Error at "' + err.filename + '" message "' + err.message +
            '" name "' + err.name + '" result 0x' + Number(err.result).toString(16);
          console.log(message);
          return message;
        }
      }

      function _getXPath(node, path) {
        path = path || [];
        if (node.parentNode) {
          path = _getXPath(node.parentNode, path);
        }

        if (node.previousSibling) {
          var count = 1;
          var sibling = node.previousSibling
          do {
            if (sibling.nodeType == 1 && sibling.nodeName == node.nodeName) {count++;}
            sibling = sibling.previousSibling;
          } while (sibling);
          if (count == 1) {count = null;}
        } else if (node.nextSibling) {
          var sibling = node.nextSibling;
          do {
            if (sibling.nodeType == 1 && sibling.nodeName == node.nodeName) {
              var count = 1;
              sibling = null;
            } else {
              var count = null;
              sibling = sibling.previousSibling;
            }
          } while (sibling);
        }

        if (node.nodeType == 1) {
          path.push(node.nodeName.toLowerCase() + (node.id ? "[@id='"+node.id+"']" : count > 0 ? "["+count+"]" : ''));
        }
        return path;
      }

      function getXPath(node) {
        var path = _getXPath(node);
        return '/' + path.join('/');
      }

      webdriver.WebDriver.prototype.visualizerGetSource = function() {
        webdriver.http.Executor.COMMAND_MAP_['visualizerGetSource'] = {
          method: 'GET', path: '/session/:sessionId/-cisco-visualizer-source'};
        return this.schedule(
          new webdriver.Command('visualizerGetSource'),
          'WebDriver.visualizerGetSource()');
      }

      webdriver.WebDriver.prototype.visualizerShowPoint = function() {
        webdriver.http.Executor.COMMAND_MAP_['visualizerShowPoint'] = {
          method: 'GET', path: '/session/:sessionId/-cisco-visualizer-show-point'};
        return this.schedule(
          new webdriver.Command('visualizerShowPoint'),
          'WebDriver.visualizerShowPoint()');
      }

      /**
       * Single tap on the touch enabled device.
       * @param {!webdriver.WebElement} element The element to tap on.
       * @return {!webdriver.ActionSequence} A self reference.
       */
      webdriver.ActionSequence.prototype.touchSingleTap = function(element) {
        webdriver.http.Executor.COMMAND_MAP_[webdriver.CommandName.TOUCH_SINGLE_TAP] = {
          method: 'POST', path: '/session/:sessionId/touch/click'};

        var command = new webdriver.Command(webdriver.CommandName.TOUCH_SINGLE_TAP);

        var id = element.toWireValue().then(function(value) {
            return value['ELEMENT'];
          });
        command.setParameter('element', id);

        this.schedule_(webdriver.CommandName.TOUCH_SINGLE_TAP, command);
        return this;
      }

      /**
       * Finger down on the screen.
       * @param {number} x X coordinate on the screen
       * @param {number} y Y coordinate on the screen
       */
      webdriver.ActionSequence.prototype.touchDown = function(x, y) {
        webdriver.http.Executor.COMMAND_MAP_[webdriver.CommandName.TOUCH_DOWN] = {
          method: 'POST', path: '/session/:sessionId/touch/down'};

        var command = new webdriver.Command(webdriver.CommandName.TOUCH_DOWN);

        command.setParameter('x', x);
        command.setParameter('y', y);

        this.schedule_(webdriver.CommandName.TOUCH_DOWN, command);
        return this;
      }

      /**
       * Finger up on the screen.
       * @param {number} x X coordinate on the screen
       * @param {number} y Y coordinate on the screen
       * @return {!webdriver.ActionSequence} A self reference.
       */
      webdriver.ActionSequence.prototype.touchUp = function(x, y) {
        webdriver.http.Executor.COMMAND_MAP_[webdriver.CommandName.TOUCH_UP] = {
          method: 'POST', path: '/session/:sessionId/touch/up'};

        var command = new webdriver.Command(webdriver.CommandName.TOUCH_UP);

        command.setParameter('x', x);
        command.setParameter('y', y);

        this.schedule_(webdriver.CommandName.TOUCH_UP, command);
        return this;
      }

      /**
       * Finger move on the screen.
       * @param {number} x X coordinate on the screen
       * @param {number} y Y coordinate on the screen
       * @return {!webdriver.ActionSequence} A self reference.
       */
      webdriver.ActionSequence.prototype.touchMove = function(x, y) {
        webdriver.http.Executor.COMMAND_MAP_[webdriver.CommandName.TOUCH_MOVE] = {
          method: 'POST', path: '/session/:sessionId/touch/move'};

        var command = new webdriver.Command(webdriver.CommandName.TOUCH_MOVE);

        command.setParameter('x', x);
        command.setParameter('y', y);

        this.schedule_(webdriver.CommandName.TOUCH_MOVE, command);
        return this;
      }

      /**
       * Scroll on the touch screen using finger based motion events.
       * @param {(!webdriver.WebElement|{x: number, y: number})} elementOrOffset Either
       *     the element where scrolls starts or offset in pixels to scroll by.
       * @param {({x: number, y: number})=} opt_offset The offset in pixels to scroll by
       *     if the first argument is the element.
       * @return {!webdriver.ActionSequence} A self reference.
       */
      webdriver.ActionSequence.prototype.touchScroll = function(elementOrOffset, opt_offset) {
        webdriver.http.Executor.COMMAND_MAP_[webdriver.CommandName.TOUCH_SCROLL] = {
          method: 'POST', path: '/session/:sessionId/touch/scroll'};

        var command = new webdriver.Command(webdriver.CommandName.TOUCH_SCROLL);

        if (opt_offset != undefined) {
          var id = elementOrOffset.toWireValue().then(function(value) {
              return value['ELEMENT'];
            });
          command.setParameter('element', id);
          command.setParameter('xoffset', opt_offset.x);
          command.setParameter('yoffset', opt_offset.y);
        } else {
          command.setParameter('xoffset', elementOrOffset.x);
          command.setParameter('yoffset', elementOrOffset.y);
        }

        this.schedule_(webdriver.CommandName.TOUCH_SCROLL, command);
        return this;
      }

      /**
       * Double tap on the touch screen using finger motion events.
       * @param {!webdriver.WebElement} element The element to double tap on.
       * @return {!webdriver.ActionSequence} A self reference.
       */
      webdriver.ActionSequence.prototype.touchDoubleClick = function(element) {
        webdriver.http.Executor.COMMAND_MAP_[webdriver.CommandName.TOUCH_DOUBLE_CLICK] = {
          method: 'POST', path: '/session/:sessionId/touch/doubleclick'};

        var command = new webdriver.Command(webdriver.CommandName.TOUCH_DOUBLE_CLICK);

        var id = element.toWireValue().then(function(value) {
            return value['ELEMENT'];
          });
        command.setParameter('element', id);

        this.schedule_(webdriver.CommandName.TOUCH_DOUBLE_CLICK, command);
        return this;
      }

      /**
       * Long press on the touch screen using finger motion events.
       * @param {!webdriver.WebElement} element The element to long press on.
       * @return {!webdriver.ActionSequence} A self reference.
       */
      webdriver.ActionSequence.prototype.touchLongClick = function(element) {
        webdriver.http.Executor.COMMAND_MAP_[webdriver.CommandName.TOUCH_LONG_CLICK] = {
          method: 'POST', path: '/session/:sessionId/touch/longclick'};

        var command = new webdriver.Command(webdriver.CommandName.TOUCH_LONG_CLICK);

        var id = element.toWireValue().then(function(value) {
            return value['ELEMENT'];
          });
        command.setParameter('element', id);

        this.schedule_(webdriver.CommandName.TOUCH_LONG_CLICK, command);
        return this;
      }

      /**
       * Flick on the touch screen using finger motion events.
       * @param {(!webdriver.WebElement|{x: number, y: number})} elementOrOffset Either
       *     the element where flick starts or speed in pixels per second.
       * @param {({x: number, y: number})=} opt_offset The offset in pixels to flick by
       *     if the first argument is the element.
       * @param {number=} opt_speed The speed in pixels per seconds if the first argument
       *     is the element.
       * @return {!webdriver.ActionSequence} A self reference.
       */
      webdriver.ActionSequence.prototype.touchFlick = function(elementOrSpeed, opt_offset, opt_speed) {
        webdriver.http.Executor.COMMAND_MAP_[webdriver.CommandName.TOUCH_FLICK] = {
          method: 'POST', path: '/session/:sessionId/touch/flick'};

        var command = new webdriver.Command(webdriver.CommandName.TOUCH_FLICK);

        if (arguments.length == 3) {
          var id = elementOrSpeed.toWireValue().then(function(value) {
              return value['ELEMENT'];
            });
          command.setParameter('element', id);
          command.setParameter('xoffset', opt_offset.x);
          command.setParameter('yoffset', opt_offset.y);
          command.setParameter('speed', opt_speed);
        } else {
          command.setParameter('xspeed', elementOrSpeed.x);
          command.setParameter('yspeed', elementOrSpeed.y);
        }

        this.schedule_(webdriver.CommandName.TOUCH_FLICK, command);
        return this;
      }

      /**
       * Pinch and rotate on the touch screen using finger motion events.
       * @param {!webdriver.WebElement} element The element to rotate.
       * @param {!number} angle The angle by which to rotate.
       * @return {!webdriver.ActionSequence} A self reference.
       */
      webdriver.ActionSequence.prototype.touchPinchRotate = function(element, angle) {
        webdriver.http.Executor.COMMAND_MAP_[webdriver.CommandName.TOUCH_PINCH_ROTATE] = {
          method: 'POST', path: '/session/:sessionId/touch/-cisco-pinch-rotate'};

        var command = new webdriver.Command(webdriver.CommandName.TOUCH_PINCH_ROTATE);

        var id = element.toWireValue().then(function(value) {
            return value['ELEMENT'];
          });
        command.setParameter('element', id);
        command.setParameter('angle', angle);

        this.schedule_(webdriver.CommandName.TOUCH_PINCH_ROTATE, command);
        return this;
      }

      /**
       * Pinch and zoom on the touch screen using finger motion events.
       * @param {!webdriver.WebElement} element The element to zoom.
       * @param {!number} scale The scale by which to zoom.
       * @return {!webdriver.ActionSequence} A self reference.
       */
      webdriver.ActionSequence.prototype.touchPinchZoom = function(element, scale) {
        webdriver.http.Executor.COMMAND_MAP_[webdriver.CommandName.TOUCH_PINCH_ZOOM] = {
          method: 'POST', path: '/session/:sessionId/touch/-cisco-pinch-zoom'};

        var command = new webdriver.Command(webdriver.CommandName.TOUCH_PINCH_ZOOM);

        var id = element.toWireValue().then(function(value) {
            return value['ELEMENT'];
          });
        command.setParameter('element', id);
        command.setParameter('scale', scale);

        this.schedule_(webdriver.CommandName.TOUCH_PINCH_ZOOM, command);
        return this;
      }

      var Util = function() {}
      Util.WebDriverKeyFromJs = function(keyCode) {
        switch (keyCode) {
          case  8: return webdriver.Key.BACK_SPACE;
          case  9: return webdriver.Key.TAB;
          case 13: return webdriver.Key.ENTER;
          case 16: return webdriver.Key.SHIFT;
          case 17: return webdriver.Key.CONTROL;
          case 18: return webdriver.Key.ALT;
          case 19: return webdriver.Key.PAUSE;
          //case 20: return ; //  caps lock
          case 27: return webdriver.Key.ESCAPE;
          case 33: return webdriver.Key.PAGE_UP;
          case 34: return webdriver.Key.PAGE_DOWN;
          case 35: return webdriver.Key.END;
          case 36: return webdriver.Key.HOME;
          case 37: return webdriver.Key.ARROW_LEFT;
          case 38: return webdriver.Key.ARROW_UP;
          case 39: return webdriver.Key.ARROW_RIGHT;
          case 40: return webdriver.Key.ARROW_DOWN;
          case 45: return webdriver.Key.INSERT;
          case 46: return webdriver.Key.DELETE;
          //case 91: return ; // left window
          //case 92: return ; // right window
          //case 93: return ; // select key
          case 96: return webdriver.Key.NUMPAD0;
          case 97: return webdriver.Key.NUMPAD1;
          case 98: return webdriver.Key.NUMPAD2;
          case 99: return webdriver.Key.NUMPAD3;
          case 100: return webdriver.Key.NUMPAD4;
          case 101: return webdriver.Key.NUMPAD5;
          case 102: return webdriver.Key.NUMPAD6;
          case 103: return webdriver.Key.NUMPAD7;
          case 104: return webdriver.Key.NUMPAD8;
          case 105: return webdriver.Key.NUMPAD9;
          case 106: return webdriver.Key.MULTIPLY;
          case 107: return webdriver.Key.ADD;
          case 109: return webdriver.Key.SUBTRACT;
          case 110: return webdriver.Key.DECIMAL; // decimal point
          case 111: return webdriver.Key.DIVIDE;
          case 112: return webdriver.Key.F1;
          case 113: return webdriver.Key.F2;
          case 114: return webdriver.Key.F3;
          case 115: return webdriver.Key.F4;
          case 116: return webdriver.Key.F5;
          case 117: return webdriver.Key.F6;
          case 118: return webdriver.Key.F7;
          case 119: return webdriver.Key.F8;
          case 120: return webdriver.Key.F9;
          case 121: return webdriver.Key.F10;
          case 122: return webdriver.Key.F11;
          case 123: return webdriver.Key.F12;
          //case 144: return ; // num lock
          //case 145: return ; // scroll lock
          case 186: return webdriver.Key.SEMICOLON;
          case 187: return webdriver.Key.EQUALS;
          //case 188: return ; // comma
          //case 189: return ; // dash
          //case 190: return .; // period
          //case 191: return /; // forward slash
          //case 192: return `; // grave accent
          //case 219: return [; // open bracket
          //case 220: return \\; // back slash
          //case 221: return ]; // close bracket
          //case 222: return '; // single quote
        }
      }

      function VisualizerXsltProcessors() {
        this.widget = this._create('widget_view_visualizer.xsl');
        this.qml = this._create('qml_view_visualizer.xsl');
      }

      VisualizerXsltProcessors.prototype.get = function(webPage) {
        if (webPage.startsWith('qtwidget://'))
          return this.widget;
        if (webPage.endsWith('.qml'))
          return this.qml;
      }

      VisualizerXsltProcessors.prototype._create = function(name) {
        var stylesheet = loadFile(name);
        stylesheet = (new DOMParser()).parseFromString(stylesheet, 'application/xml');
        var processor = new XSLTProcessor();
        try {
          processor.importStylesheet(stylesheet);
          return processor;
        } catch (err) {
          console.log(err);
        }
      }

      function WebDriverJsDemo() {
        this.xsltProcessors = new VisualizerXsltProcessors();
      }

      WebDriverJsDemo.prototype._constructWebDriver = function() {
        var webDriverUrlPort = document.getElementsByName('webDriverUrlPort')[0].value;
        var webPage = document.getElementsByName('webPage')[0].value;

        if (this.webDriverUrlPort == webDriverUrlPort &&
            this.webPage == webPage)
          return;

        if (this.webDriverUrlPort != webDriverUrlPort) {
          var capabilities = {'browserName': 'qtwebkit'};

          var client = new webdriver.http.CorsClient(webDriverUrlPort);
          var executor = new webdriver.http.Executor(client);
          var session = webdriver.Session.getSessions(executor).then(function(sessions) {
            if (sessions[0])
              return sessions[0];
            else
              return webdriver.WebDriver.createSession(executor, capabilities).getSession();
          });

          this.driver = new webdriver.WebDriver(session, executor);

          this.webDriverUrlPort = localStorage.webDriverUrlPort = webDriverUrlPort;
        }

        if (this.webPage != webPage) {
          this.driver.get(webPage);
          this.element = null;

          this.webPage = localStorage.webPage = webPage;
        }
      }

      WebDriverJsDemo.prototype.get = function() {
        this.webPage = null;
        this._constructWebDriver();
      }

      WebDriverJsDemo.prototype.source = function() {
        this._constructWebDriver();
        this.updateSource();
      }

      WebDriverJsDemo.prototype.screenshot = function() {
        this._constructWebDriver();
        this.driver.takeScreenshot().then(function(data) {
          data = base64_arraybuffer.decode(data);
          data = new Blob([data], {type: 'image/png'});
          saveAs(data, 'screenshot.png');
        })
      }

      WebDriverJsDemo.prototype.findElementById = function() {
        this._constructWebDriver();
        var name = document.getElementsByName('elementId')[0].value;
        this.element = this.driver.findElement(webdriver.By.id(name));
      }

      WebDriverJsDemo.prototype.findElementByName = function() {
        this._constructWebDriver();
        var name = document.getElementsByName('elementName')[0].value;
        this.element = this.driver.findElement(webdriver.By.name(name));
      }

      WebDriverJsDemo.prototype.findElementByTagName = function() {
        this._constructWebDriver();
        var name = document.getElementsByName('elementTagName')[0].value;
        this.element = this.driver.findElement(webdriver.By.tagName(name));
      }

      WebDriverJsDemo.prototype.sendKeys = function(key) {
        this._constructWebDriver();
        if (this.element) {
          this.element.sendKeys(key);
        } else {
          this.driver.actions().sendKeys(key).perform();
        }
      }

      WebDriverJsDemo.prototype.click = function() {
        this._constructWebDriver();
        this.element.click();
      }

      WebDriverJsDemo.prototype.setWindowSize = function() {
        this._constructWebDriver();
        var width = document.getElementsByName('windowSizeWidth')[0].value;
        var height = document.getElementsByName('windowSizeHeight')[0].value;
        width = parseInt(width);
        height = parseInt(height);
        this.driver.manage().window().setSize(width, height);
      }

      WebDriverJsDemo.prototype.updateSource = function() {
        var self = this;
        this.driver.visualizerGetSource().then(function(source) {
          self.driver.manage().window().getSize().then(function(targetSize) {
            self.showVisualizationWindow(source, targetSize);
          });
        });
      }

      WebDriverJsDemo.prototype.isVisualizerOpened = function() {
        return this.visualizationWin && !this.visualizationWin.closed && this.visualizationWin.innerHeight > 0;
      }

      WebDriverJsDemo.prototype.openVisualizationWindow = function(size) {
        var winParams = 'width=' + size.width + ',height=' + size.height;
        this.visualizationWin = window.open('', '', winParams);
      }

      WebDriverJsDemo.prototype.visualizerAssignEventHandlers = function() {
        var self = this;
        var win = this.visualizationWin;

        win.document.onkeypress = function(event) {
          var key = String.fromCharCode(event.charCode);

          if (event.target.hasAttribute('elementId')) {
            var elementId = event.target.getAttribute('elementId');
            var element = new webdriver.WebElement(self.driver, elementId);
            element.sendKeys(key);
          } else {
            self.driver.actions().sendKeys(key).perform();
          }

          return true;
        }

        win.document.onkeyup = function(event) {
          var key = Util.WebDriverKeyFromJs(event.keyCode);
          if (!key)
            return true;

          if (event.target.hasAttribute('elementId')) {
            var elementId = event.target.getAttribute('elementId');
            var element = new webdriver.WebElement(self.driver, elementId);
            element.sendKeys(key);
          } else {
            self.driver.actions().sendKeys(key).perform();
          }

          return true;
        }

        win.document.onclick = function(event) {
          var disableClickEvent = document.getElementsByName('disableClickEvent')[0].checked;
          if (disableClickEvent) {
            return;
          }

          if (event.target.hasAttribute('elementId')) {
            var elementId = event.target.getAttribute('elementId');
            var element = new webdriver.WebElement(self.driver, elementId);
            element.click();
            return true;
          }

          var xpath = getXPath(event.target);
          var target = self.driver.findElement(webdriver.By.xpath(xpath));
          self.driver.actions().
            mouseMove(target, {x: event.offsetX, y: event.offsetY}).
            click(event.button).
            perform().
          then(function() {
            return self.driver.visualizerShowPoint();
          }).then(function() {
//            self.updateSource();
          });

          return false;
        }

        Hammer.detection.gestures = [];
        Hammer.READY = false;
        Hammer.DOCUMENT = win.document;
        var hammer = Hammer(win.document, {
          prevent_default: true});

        hammer.on("tap", function(event) {
          var xpath = getXPath(event.target);
          var target = self.driver.findElement(webdriver.By.xpath(xpath));
          self.driver.actions().
            touchSingleTap(target).
            perform();
        });

        hammer.on("hold", function(event) {
          var xpath = getXPath(event.target);
          var target = self.driver.findElement(webdriver.By.xpath(xpath));
          self.driver.actions().
            touchLongClick(target).
            perform();
        });

        hammer.on("doubletap", function(event) {
          var xpath = getXPath(event.target);
          var target = self.driver.findElement(webdriver.By.xpath(xpath));
          self.driver.actions().
            touchDoubleTap(target).
            perform();
        });

        hammer.on("touch", function(event) {
          self.driver.actions().
            touchDown(event.gesture.center.pageX, event.gesture.center.pageY).
            perform();
        });

        hammer.on("release", function(event) {
          self.driver.actions().
            touchUp(event.gesture.center.pageX, event.gesture.center.pageY).
            perform();
        });

        hammer.on("drag", function(event) {
          self.driver.actions().
            touchMove(event.gesture.center.pageX, event.gesture.center.pageY).
            perform();
        });

        hammer.on("dragstart", function(event) {
          var xpath = getXPath(event.target);
          self.dragstart = self.driver.findElement(webdriver.By.xpath(xpath));
        });

        hammer.on("dragend", function(event) {
          if (self.dragstart) {
            self.driver.actions().
              touchScroll(self.dragstart, {x: event.gesture.deltaX, y: event.gesture.deltaY}).
              perform();
          } else {
            self.driver.actions().
              touchScroll({x: event.gesture.deltaX, y: event.gesture.deltaY}).
              perform();
          }
          self.dragstart = null;
        });

        hammer.on("swipe", function(event) {
          if (self.dragstart) {
            var offset = {x: event.gesture.deltaX, y: event.gesture.deltaY};
            var speed = Math.sqrt(offset.x * offset.x + offset.y * offset.y) * 1000 / event.gesture.deltaTime;
            self.driver.actions().
              touchFlick(self.dragstart, offset, speed).
              perform();
          } else {
            var xspeed = Math.floor(event.gesture.velocityX * 1000);
            var yspeed = Math.floor(event.gesture.velocityY * 1000);
            self.driver.actions().
              touchFlick({x: xspeed, y: yspeed}).
              perform();
          }
        });

        hammer.on("rotate", function(event) {
          var xpath = getXPath(event.target);
          var target = self.driver.findElement(webdriver.By.xpath(xpath));
          self.driver.actions().
            touchPinchRotate(target, event.gesture.rotation).
            perform();
        });

        hammer.on("pinch", function(event) {
          var xpath = getXPath(event.target);
          var target = self.driver.findElement(webdriver.By.xpath(xpath));
          self.driver.actions().
            touchPinchZoom(target, event.gesture.scale).
            perform();
        });
      }

      WebDriverJsDemo.prototype.showVisualizationWindow = function(source, size) {
        var isQt = this.webPage.startsWith('qtwidget://') || this.webPage.endsWith('.qml');
        var isWinOpened = this.isVisualizerOpened();

        if (!isQt && isWinOpened) {
          this.visualizationWin.document.documentElement.innerHTML = source;
          this.visualizationWin.resizeTo(size.width, size.height);
          return;
        }

        if (!isWinOpened)
          this.openVisualizationWindow(size);

        if (isQt) {
          var xsltProcessor = this.xsltProcessors.get(this.webPage);
          var receivedDoc = (new DOMParser()).parseFromString(source, 'application/xml');
          receivedDoc = xsltProcessor.transformToDocument(receivedDoc);
          var visualizerDoc = this.visualizationWin.document;
          visualizerDoc.replaceChild(receivedDoc.documentElement, visualizerDoc.documentElement);
        } else {
          var visualizerDoc = this.visualizationWin.document;
          visualizerDoc.write(source);
        }

        this.visualizerAssignEventHandlers();
      }

      WebDriverJsDemo.prototype.quit = function() {
        if (!this.driver)
          return;

        this.driver.quit();
        this.webDriverUrlPort = null;
        this.webPage = null;
      }

      function init() {
        if (localStorage.webDriverUrlPort) {
          var input = document.getElementsByName('webDriverUrlPort')[0];
          input.value = localStorage.webDriverUrlPort;
        }

        if (localStorage.webPage) {
          var input = document.getElementsByName('webPage')[0];
          input.value = localStorage.webPage;
        }
      }

      var wd = new WebDriverJsDemo();
    </script>
  </head>
  <body onload="init()">
    <table border="0">
      <tr>
        <td>WebDriver url and port</td>
        <td>
          <input name="webDriverUrlPort" type="text"/>
        </td>
      </tr>
      <tr>
        <td>Web page</td>
        <td>
          <input name="webPage" type="text"/>
          <input type="button" value="GET" onclick="wd.get()"/>
          <input type="button" value="Source" onclick="wd.source()"/>
          <input type="button" value="Screenshot" onclick="wd.screenshot()"/>
        </td>
      </tr>
    </table>

    <div class="commandBlock">
      <div>
        <input type="submit" value="Find element" onclick="wd.findElementById()">
        by id
        <input name="elementId" type="text"/>
      </div>
      <div>
        <input type="submit" value="Find element" onclick="wd.findElementByName()">
        by name
        <input name="elementName" type="text"/>
      </div>
      <div>
        <input type="submit" value="Find element" onclick="wd.findElementByTagName()">
        by tag name
        <input name="elementTagName" type="text"/>
      </div>
    </div>

    <div class="commandBlock">
      <div style="position: absolute;">Key down:</div>
      <div style="margin-left: 80px;">
        <div>
          <input type="submit" value="ESC" onclick="wd.sendKeys(webdriver.Key.ESCAPE)"/>
          <input type="submit" value="Q" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="W" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="E" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="R" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="T" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="Y" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="U" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="I" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="O" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="P" onclick="wd.sendKeys(this.value)"/>
        </div>
        <div>
          <input type="submit" value="A" onclick="wd.sendKeys(this.value)" style="margin-left: 53px;"/>
          <input type="submit" value="S" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="D" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="F" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="G" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="H" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="J" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="K" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="L" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="Enter" onclick="wd.sendKeys(webdriver.Key.ENTER)"/>
        </div>
        <div>
          <input type="submit" value="Z" onclick="wd.sendKeys(this.value)" style="margin-left: 53px;"/>
          <input type="submit" value="X" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="C" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="V" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="B" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="N" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="M" onclick="wd.sendKeys(this.value)"/>
          <input type="submit" value="&#8657;" onclick="wd.sendKeys(webdriver.Key.UP)" style="margin-left: 45px;"/>
        </div>
        <div>
          <input type="submit" value=" " onclick="wd.sendKeys(this.value)" style="width: 100px; margin-left: 100px;"/>
          <input type="submit" value="&#8656;" onclick="wd.sendKeys(webdriver.Key.LEFT)" style="margin-left: 91px;"/>
          <input type="submit" value="&#8659;" onclick="wd.sendKeys(webdriver.Key.DOWN)"/>
          <input type="submit" value="&#8658;" onclick="wd.sendKeys(webdriver.Key.RIGHT)"/>
        </div>
      </div>
    </div>

    <div class="commandBlock">
      <input type="submit" value="Set window size" onclick="wd.setWindowSize()"/>
      <input name="windowSizeWidth" type="text" style="width: 50px"/>
      <span class="unitLabel">px</span> width and
      <input name="windowSizeHeight" type="text" style="width: 50px"/>
      <span class="unitLabel">px</span> height.
    </div>

    <div class="commandBlock">
      <input name="disableClickEvent" type="checkbox" style="width: 50px">Disable click events (send touch only)</input>
    </div>

    <div style="margin-top: 20px">
      <input type="submit" value="Quit" onclick="wd.quit()"/>
    </div>
  </body>
</html>